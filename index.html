<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•æ…‹è³‡æ–™è¦–è¦ºåŒ–å·¥å…· Data Visualizer</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ html2canvas (æˆªåœ–ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- è¼‰å…¥ gif.js (GIF ç·¨ç¢¼ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <!-- ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* æ³¨æ„ï¼šæˆ‘å€‘ä¿ç•™ CSS transition ç”¨æ–¼ç¶²é ä¸Šçš„å³æ™‚é è¦½ã€‚
           ä½†åœ¨ç”Ÿæˆ GIF æ™‚ï¼Œæˆ‘å€‘æœƒé€é JS æš«æ™‚ç§»é™¤é€™äº› class æˆ–è¦†å¯«æ¨£å¼ï¼Œ
           æ”¹ç‚ºæ‰‹å‹•é€å¹€æ§åˆ¶ã€‚
        */
        .bar-visual {
            transition: width 1.5s ease-out;
            transform-origin: left;
        }
        .donut-segment {
            transition: stroke-dasharray 1.5s ease-out, stroke-dashoffset 1.5s ease-out;
            transform-origin: 50% 50%;
            transform: rotate(-90deg);
        }
        .chart-element-animate {
            transition: transform 1.5s ease-out, height 1.5s ease-out;
        }
        .rectangle-bar {
            transform-origin: bottom;
        }
        .circle-visual, .line-marker {
            transform-origin: center;
        }
        /* é›·é”åœ–å‹•ç•«ï¼šä½¿ç”¨ SVG å±¬æ€§éæ¸¡è¼ƒç‚ºè¤‡é›œï¼Œä¸»è¦ä¾è³´ JS è¨ˆç®— */
        .radar-polygon {
            transition: d 1.5s ease-out;
        }
        .radar-point {
            transition: cx 1.5s ease-out, cy 1.5s ease-out;
        }

        /* è¼‰å…¥é®ç½©æ¨£å¼ */
        #loadingOverlay {
            backdrop-filter: blur(5px);
        }
        
        /* æ¨™ç±¤æ–‡å­—æ¨£å¼ */
        .chart-label {
            text-shadow: 0px 0px 2px rgba(255,255,255,0.8);
            pointer-events: none;
        }
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6V4ZXXZXS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z6V4ZXXZXS');
</script>

<body class="min-h-screen p-4 md:p-8 relative">
    
    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex flex-col items-center justify-center text-white">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <h3 class="text-xl font-bold" id="loadingText">æ­£åœ¨è£½ä½œ GIF...</h3>
        <p class="text-sm opacity-80 mt-2">å°å¹«æ‰‹æ­£åœ¨åŠªåŠ›è£½ä½œä¸­ï¼Œé‚„éœ€è¦å¹¾ç§’é˜ï¼Œè«‹ç­‰ä¸€ä¸‹~~</p>
        <div class="w-64 h-2 bg-gray-700 rounded-full mt-4 overflow-hidden">
            <div id="progressBar" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <div id="app" class="max-w-6xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        <header class="p-6 md:p-8 bg-green-300 text-white">
            <h1 class="text-3xl text-gray-800 font-bold tracking-tight">å‹•æ…‹è³‡æ–™è¦–è¦ºåŒ–å·¥å…· Data Visualizer ğŸ’¡</h1>
            <p class="mt-1 opacity-90 text-gray-800 ">è¼¸å…¥æ‚¨çš„æ•¸æ“šï¼Œå³æ™‚ç”Ÿæˆå‹•æ…‹åœ–è¡¨é è¦½ä¸¦ä¸‹è¼‰ GIF å‹•æ…‹åœ–æª”æˆ– PNG éœæ…‹åœ–æª”ã€‚</p>
        </header>

        <div class="grid grid-cols-1 lg:col-span-3 gap-8 p-6 md:p-8">
            <!-- å·¦å´: è¨­å®šé¢æ¿ -->
            <div class="lg:col-span-1 space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">æ•¸æ“šè¼¸å…¥èˆ‡è¨­å®š</h2>

                <!-- GIF æ¨™é¡Œ -->
                <div>
                    <label for="gifTitle" class="block text-sm font-medium text-gray-700 mb-1">å‹•ç•«æ¨™é¡Œ</label>
                    <input type="text" id="gifTitle" maxlength="96" value="æ‚¨çš„æ•¸æ“šæ¯”è¼ƒ"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           oninput="updatePreview()">
                </div>
                
                <!-- å–®ä½è¨­å®š (æ–°å¢) -->
                <div>
                    <label for="dataUnit" class="block text-sm font-medium text-gray-700 mb-1">å–®ä½ (é¸å¡«)</label>
                    <input type="text" id="dataUnit" maxlength="20" placeholder="ä¾‹å¦‚: kg, äºº, å…ƒ"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           oninput="updateUnit(this.value)">
                </div>

                <!-- è®Šæ•¸è¼¸å…¥å€ -->
                <div id="variablesContainer" class="space-y-4">
                    <!-- Variables will be injected here -->
                </div>

                <!-- æ–°å¢è®Šæ•¸æŒ‰éˆ• -->
                <button onclick="addVariable()" id="addVariableBtn"
                        class="w-full flex items-center justify-center px-4 py-2 border border-dashed border-blue-400 text-sm font-medium rounded-lg text-blue-600 hover:bg-blue-50 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    æ–°å¢æ¯”è¼ƒè®Šæ•¸ (æœ€å¤š 5 å€‹)
                </button>
            </div>

            <!-- å³å´: è¦–è¦ºåŒ–é è¦½èˆ‡æ§åˆ¶ -->
            <div class="lg:col-span-2 space-y-6 bg-gray-50 p-6 rounded-xl shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">é è¦½èˆ‡æ¨£å¼</h2>

                <!-- æ¨£å¼é¸æ“‡ -->
                <div>
                    <span class="text-sm font-medium text-gray-600 mb-2 block">é¸æ“‡åœ–è¡¨æ¨£å¼:</span>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="bars" checked onclick="setChartStyle('bars')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">é•·æ¢åœ– (Bars)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="donut" onclick="setChartStyle('donut')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">ç”œç”œåœˆåœ– (Donut)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="pie" onclick="setChartStyle('pie')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">æ¯”ä¾‹å †ç–Šæ–¹å¡Š(Rectangles)</span>
                        </label>
                         <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="prop_squares" onclick="setChartStyle('prop_squares')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">æ¯”ä¾‹é¢ç©æ–¹å¡Š  (Squares)</span>
                        </label>
                         <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="circles" onclick="setChartStyle('circles')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">æ¯”ä¾‹é¢ç©åœ“åœˆ (Circles)</span>
                        </label>
                         <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="rectangles" onclick="setChartStyle('rectangles')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">æŸ±ç‹€åœ– (Vertical Bars)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="line" onclick="setChartStyle('line')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">æŠ˜ç·šåœ– (Line)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white transition duration-150 border bg-white shadow-sm">
                            <input type="radio" name="chartStyle" value="radar" onclick="setChartStyle('radar')" class="form-radio text-blue-600 h-4 w-4">
                            <span class="text-sm font-medium text-gray-700">é›·é”åœ– (Radar)</span>
                        </label>
                    </div>
                </div>

                <!-- é¡¯ç¤ºè¨­å®šæ§åˆ¶ (æ–°å¢) -->
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm space-y-3">
                    <h3 class="text-sm font-bold text-gray-700">è³‡æ–™æ¨™ç±¤èˆ‡é¡¯ç¤ºè¨­å®š</h3>
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <!-- é¡¯ç¤ºæ¨™ç±¤é–‹é—œ -->
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="toggleLabels" class="sr-only" checked onchange="toggleLabels(this.checked)">
                                <div class="w-10 h-6 bg-gray-200 rounded-full shadow-inner toggle-bg transition duration-200 ease-in-out"></div>
                                <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition transform duration-200 ease-in-out"></div>
                            </div>
                            <div class="ml-3 text-sm font-medium text-gray-700">
                                é¡¯ç¤ºè³‡æ–™æ¨™ç±¤
                            </div>
                        </label>
                        
                        <div class="h-6 w-px bg-gray-300 hidden md:block"></div>

                        <!-- æ•¸å€¼æ¨¡å¼åˆ‡æ› -->
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="valueMode" value="raw" checked onchange="setValueMode('raw')" class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-gray-700">é¡¯ç¤ºåŸå§‹æ•¸å€¼</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="valueMode" value="percent" onchange="setValueMode('percent')" class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-gray-700">è½‰æ›æˆç™¾åˆ†æ¯”</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- é è¦½å€ - è¨­å®šæ˜ç¢ºçš„ç™½è‰²èƒŒæ™¯ä»¥ä¾›æˆªåœ– -->
                <div id="previewArea" class="p-6 bg-white shadow-lg rounded-xl min-h-[400px] flex flex-col justify-center border border-gray-100">
                    <div class="text-center mb-6">
                        <h3 id="previewTitle" class="text-3xl font-extrabold text-gray-900 leading-snug">æ‚¨çš„æ•¸æ“šæ¯”è¼ƒ</h3>
                    </div>

                    <div id="chartContainer" class="space-y-4">
                        <!-- Chart visuals will be rendered here -->
                    </div>
                </div>

                <!-- ä¸‹è¼‰/åˆ†äº«æŒ‰éˆ• -->
                <div class="pt-4 border-t mt-6 flex justify-end space-x-3">
                    <button onclick="downloadPNG()"
                            class="px-4 py-3 bg-gray-600 text-white font-bold text-sm rounded-xl shadow hover:bg-gray-700 transition duration-150">
                        ä¸‹è¼‰ PNG éœæ…‹åœ–æª”
                    </button>
                    <button onclick="generateGIF()"
                            class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-800 text-white font-bold text-lg rounded-xl shadow-lg hover:from-green-900 hover:to-green-900 transition duration-150 transform hover:scale-[1.02]">
                        âœ¨ ä¸‹è¼‰ GIF å‹•ç•«åœ–æª”  âœ¨
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center py-6 border-t border-gray-100 bg-gray-50">
            <p class="text-gray-500 text-sm">
                Created by <a href="https://www.aaronshi.cc" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-600 hover:text-blue-500 transition-colors">AaronShi.cc</a>
            </p>
        </div>
    </div>

    <!-- Toggle Switch CSS -->
    <style>
        input:checked ~ .toggle-bg {
            background-color: #3b82f6;
        }
        input:checked ~ .dot {
            transform: translateX(100%);
        }
    </style>

    <script>
        // --- è¨­å®šèˆ‡è®Šæ•¸ ---
        const MAX_VARIABLES = 5;
        let variables = [
            { name: 'é¸é … A', value: 75, color: '#3b82f6' },
            { name: 'é¸é … B', value: 25, color: '#f59e0b' },
            { name: 'é¸é … C', value: 50, color: '#10b981' } 
        ];
        const colors = ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'];
        
        const CHART_STYLES = {
            BARS: 'bars',
            DONUT: 'donut',
            PIE: 'pie', 
            PROP_SQUARES: 'prop_squares', 
            CIRCLES: 'circles',
            RECTANGLES: 'rectangles',
            LINE: 'line',
            RADAR: 'radar'
        };
        let chartStyle = CHART_STYLES.BARS;
        
        // é¡¯ç¤ºè¨­å®š
        let displayConfig = {
            showLabels: true,
            valueMode: 'raw', // 'raw' or 'percent'
            unit: ''
        };

        // --- æ ¸å¿ƒé‚è¼¯ ---

        function setChartStyle(style) {
            chartStyle = style;
            updatePreview();
        }

        function toggleLabels(checked) {
            displayConfig.showLabels = checked;
            updatePreview();
        }

        function setValueMode(mode) {
            displayConfig.valueMode = mode;
            updatePreview();
        }
        
        function updateUnit(val) {
            displayConfig.unit = val;
            updatePreview();
        }

        function colorPickerHtml(index, currentColor) {
            return `
                <div class="flex space-x-2 p-2 rounded-lg border border-gray-200">
                    ${colors.map(color => `
                        <button type="button" 
                                class="w-6 h-6 rounded-full border-2 ${currentColor === color ? 'border-gray-900 ring-2 ring-offset-1 ring-gray-400' : 'border-gray-300'}"
                                style="background-color: ${color};"
                                onclick="updateColor(${index}, '${color}')"
                                title="${color}">
                        </button>
                    `).join('')}
                </div>
            `;
        }

        function renderVariables() {
            const container = document.getElementById('variablesContainer');
            container.innerHTML = variables.map((v, index) => `
                <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm space-y-3">
                    <div class="flex justify-between items-center">
                        <h4 class="font-medium text-gray-700">è®Šæ•¸ ${index + 1}</h4>
                        ${variables.length > 2 ? `
                            <button onclick="removeVariable(${index})" title="ç§»é™¤è®Šæ•¸"
                                class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition duration-150">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        ` : ''}
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">åç¨±</label>
                        <input type="text" value="${v.name}" maxlength="72"
                               oninput="updateVariableName(${index}, this.value)"
                               class="w-full p-2 text-sm border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex space-x-3">
                        <div class="flex-grow">
                            <label class="block text-xs font-medium text-gray-500 mb-1">æ•¸å€¼ (å¿…é ˆ > 0)</label>
                            <input type="number" min="1" value="${v.value}"
                                   oninput="updateVariableValue(${index}, this.value)"
                                   class="w-full p-2 text-sm border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">é¡è‰²</label>
                            ${colorPickerHtml(index, v.color)}
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('addVariableBtn').disabled = variables.length >= MAX_VARIABLES;
        }

        function updateVariableName(index, name) { variables[index].name = name; updatePreview(); }
        function updateVariableValue(index, value) {
            const numValue = parseInt(value);
            if (!isNaN(numValue) && numValue > 0) { variables[index].value = numValue; updatePreview(); }
        }
        function updateColor(index, color) { variables[index].color = color; renderVariables(); updatePreview(); }
        
        function addVariable() {
            if (variables.length < MAX_VARIABLES) {
                const availableColors = colors.filter(c => !variables.some(v => v.color === c));
                variables.push({ name: `é¸é … ${variables.length + 1}`, value: 50, color: availableColors[0] || colors[0] });
                renderVariables(); updatePreview();
            }
        }
        function removeVariable(index) { if (variables.length > 2) { variables.splice(index, 1); renderVariables(); updatePreview(); } }

        // --- æ•¸å€¼æ ¼å¼åŒ–è¼”åŠ©å‡½å¼ ---
        function formatValue(value, total) {
            if (displayConfig.valueMode === 'percent') {
                const pct = total > 0 ? (value / total) * 100 : 0;
                return `${pct.toFixed(1)}%`;
            } else {
                return `${value}${displayConfig.unit ? ' ' + displayConfig.unit : ''}`;
            }
        }

        // --- æ¸²æŸ“èˆ‡æ¨£å¼æ‡‰ç”¨ ---

        function getChartHTML(style, vars, total, maxVal) {
            // Helper: Bars
            if (style === CHART_STYLES.BARS) {
                return vars.map((v, i) => {
                    const displayVal = formatValue(v.value, total);
                    // æ ¹æ“šè¨­å®šæ±ºå®šæ˜¯å¦é¡¯ç¤ºè©³ç´°æ•¸å€¼
                    const textContent = displayConfig.showLabels ? `${displayVal}` : '';
                    
                    return `
                    <div class="flex items-center space-x-4">
                        <div class="w-1/4 flex-shrink-0 text-right">
                            <span class="text-sm font-semibold text-gray-700">${v.name}</span>
                            <span class="block text-xs text-gray-500">${textContent}</span>
                        </div>
                        <div class="flex-grow h-10 bg-gray-200 rounded-full overflow-hidden relative shadow-inner">
                            <div id="el-${i}" class="bar-visual h-full rounded-full flex items-center justify-end pr-2 text-white font-bold"
                                 style="background-color: ${v.color}; width: 0%;"></div>
                        </div>
                    </div>`;
                }).join('');
            }
            
            // Helper: Donut
            if (style === CHART_STYLES.DONUT) {
                const R = 100, C = 2 * Math.PI * R;
                let cumulativePercentage = 0;
                
                // Segments
                const segments = vars.map((v, i) => `
                    <circle id="el-${i}" cx="120" cy="120" r="${R}" fill="none" stroke="${v.color}" stroke-width="35" 
                        stroke-dasharray="0 ${C}" stroke-dashoffset="0" class="donut-segment" stroke-linecap="round" />
                `).join('');

                // Labels on segments
                let labelsOnChart = '';
                if (displayConfig.showLabels) {
                    labelsOnChart = vars.map((v, i) => {
                         const value = v.value > 0 ? v.value : 0;
                         const percentage = total > 0 ? (value / total) : 0;
                         const startAngle = cumulativePercentage * 2 * Math.PI; // radians
                         cumulativePercentage += percentage;
                         const endAngle = cumulativePercentage * 2 * Math.PI;
                         const midAngle = startAngle + (endAngle - startAngle) / 2 - Math.PI/2; // -90deg offset
                         
                         // Position text at radius 100 (center of stroke width 35 is approx at 100 radius? No, stroke is centered on R=100)
                         // Donut radius is 100. Stroke width is 35. So the ring goes from 82.5 to 117.5. Center is 100.
                         const tx = 120 + 100 * Math.cos(midAngle);
                         const ty = 120 + 100 * Math.sin(midAngle);
                         
                         // Only show label if segment is large enough
                         if (percentage < 0.05) return '';

                         return `<text x="${tx}" y="${ty}" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="white" font-weight="bold" class="chart-label">${formatValue(value, total)}</text>`;
                    }).join('');
                }

                const legend = vars.map(v => `<div class="flex items-center space-x-2"><div class="w-3 h-3 rounded-full" style="background-color: ${v.color};"></div><span class="text-sm text-gray-700">${v.name}</span></div>`).join('');
                return `<div class="flex flex-col md:flex-row items-center justify-center space-y-6 md:space-y-0 md:space-x-12"><div class="flex-shrink-0"><svg width="240" height="240" viewBox="0 0 240 240"><circle cx="120" cy="120" r="${R}" fill="none" stroke="#e5e7eb" stroke-width="35"/>${segments}${labelsOnChart}<text x="120" y="130" text-anchor="middle" class="text-xl font-bold text-gray-600">ç¸½è¨ˆ</text><text x="120" y="150" text-anchor="middle" class="text-sm text-gray-500">${total}</text></svg></div><div class="space-y-3 p-4 border rounded-lg">${legend}</div></div>`;
            }

            // Helper: Stacked Squares
            if (style === CHART_STYLES.PIE) {
                const SIZE = 200;
                let segments = vars.map((v, i) => `
                    <div id="el-${i}" class="chart-element-animate absolute w-full rounded-none flex items-center justify-center overflow-hidden" style="background-color: ${v.color}; height: 0%; bottom: 0; width: 100%;">
                        ${displayConfig.showLabels ? `<span class="text-white font-bold text-xs chart-label">${formatValue(v.value, total)}</span>` : ''}
                    </div>
                `).join(''); 
                const legend = vars.map(v => `<div class="flex items-center space-x-2"><div class="w-3 h-3 rounded-full" style="background-color: ${v.color};"></div><span class="text-sm text-gray-700">${v.name}</span></div>`).join('');
                return `<div class="flex flex-col md:flex-row items-center justify-center space-y-6 md:space-y-0 md:space-x-12"><div class="w-[${SIZE}px] h-[${SIZE}px] bg-gray-200 shadow-xl border-4 border-gray-100 rounded-lg relative overflow-hidden flex-shrink-0">${segments}</div><div class="space-y-3 p-4 border rounded-lg">${legend}</div></div>`;
            }

            // Helper: Rectangles
            if (style === CHART_STYLES.RECTANGLES) {
                const MAX_H = 200;
                const rects = vars.map((v, i) => {
                    const displayVal = formatValue(v.value, total);
                    return `
                    <div class="flex flex-col items-center w-1/5 min-w-[80px] space-y-2">
                        <span class="text-sm font-bold text-gray-800" style="opacity: ${displayConfig.showLabels ? 1 : 0}">${displayVal}</span>
                        <div class="h-[${MAX_H}px] w-full bg-gray-200 rounded-t-lg flex items-end overflow-hidden shadow-inner">
                            <div id="el-${i}" class="rectangle-bar chart-element-animate w-full rounded-t-lg" style="background-color: ${v.color}; height: 0%;"></div>
                        </div>
                        <span class="text-sm font-semibold text-gray-700 truncate w-full text-center">${v.name}</span>
                    </div>`;
                }).join('');
                return `<div class="flex flex-wrap justify-center items-end gap-6 p-4">${rects}</div>`;
            }

            // Helper: Circles / Squares (Proportional)
            if (style === CHART_STYLES.CIRCLES || style === CHART_STYLES.PROP_SQUARES) {
                const BASE = 120;
                const items = vars.map((v, i) => {
                   return `
                    <div class="flex flex-col items-center justify-end w-1/5 min-w-[120px] p-2 space-y-2">
                        <div class="relative w-full h-[${BASE}px] flex items-center justify-center">
                            <svg width="${BASE}" height="${BASE}" viewBox="0 0 ${BASE} ${BASE}" class="absolute">
                                ${style === CHART_STYLES.CIRCLES 
                                  ? `<circle id="el-${i}" cx="${BASE/2}" cy="${BASE/2}" r="${BASE/2}" fill="${v.color}" class="circle-visual chart-element-animate" style="transform: scale(0);"/>`
                                  : `<rect id="el-${i}" x="0" y="0" width="${BASE}" height="${BASE}" fill="${v.color}" class="chart-element-animate" style="transform: scale(0); transform-origin: center;"/>`
                                }
                            </svg>
                        </div>
                        <span class="text-sm font-semibold text-gray-700 truncate w-full text-center">${v.name}</span>
                        <span class="text-xs text-gray-500" style="opacity: ${displayConfig.showLabels ? 1 : 0}">${formatValue(v.value, total)}</span>
                    </div>`; 
                }).join('');
                return `<div class="flex flex-wrap justify-center items-end gap-4 p-4">${items}</div>`;
            }

            // Helper: Line
            if (style === CHART_STYLES.LINE) {
                const W = 500, H = 200, P = 30;
                if (vars.length < 2) return `<div class="text-center p-10">æŠ˜ç·šåœ–éœ€è¦è‡³å°‘ 2 å€‹æ•¸æ“šé»</div>`;
                
                const effMax = maxVal > 0 ? maxVal : 1;
                const stepX = (W - 2*P) / (vars.length - 1);
                const points = vars.map((v, i) => ({ x: P + i*stepX, y: H - P - ((v.value/effMax)*(H - 2*P)) }));
                const d = points.map((p, i) => `${i===0?'M':'L'} ${p.x} ${p.y}`).join(' ');

                const markers = points.map((p, i) => `<circle id="el-marker-${i}" cx="${p.x}" cy="${p.y}" r="8" fill="${vars[i].color}" stroke="white" stroke-width="2" class="line-marker chart-element-animate" style="transform: scale(0);"/>`).join('');
                // Labels updated to show Name + Value
                const labels = points.map((p, i) => {
                    const displayVal = formatValue(vars[i].value, total);
                    const labelText = displayConfig.showLabels ? `${vars[i].name} (${displayVal})` : vars[i].name;
                    return `<text x="${p.x}" y="${H-P+15}" text-anchor="middle" font-size="12" fill="#666">${labelText}</text>`;
                }).join('');

                return `
                <div class="flex justify-center p-4">
                    <svg width="100%" height="${H+20}" viewBox="0 0 ${W} ${H+20}" class="bg-white rounded-lg shadow border">
                        <line x1="${P}" y1="${H-P}" x2="${W-P}" y2="${H-P}" stroke="#ccc" stroke-width="2"/>
                        <path id="el-line" d="${d}" fill="none" stroke="#3b82f6" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" style="stroke-dasharray: 0; stroke-dashoffset: 0;"/>
                        ${markers} ${labels}
                    </svg>
                </div>`;
            }

            // Helper: Radar Chart
            if (style === CHART_STYLES.RADAR) {
                const SIZE = 300;
                const CX = SIZE/2;
                const CY = SIZE/2;
                const RADIUS = 100;
                const count = vars.length;

                if (count < 2) return `<div class="text-center p-10">é›·é”åœ–éœ€è¦è‡³å°‘ 2 å€‹æ•¸æ“šé»</div>`;

                // Generate Grid
                let gridLines = '';
                const levels = [0.25, 0.5, 0.75, 1];
                
                if (count === 2) {
                     gridLines += levels.map(l => {
                         const r = RADIUS * l;
                         return `<line x1="${CX-r}" y1="${CY}" x2="${CX+r}" y2="${CY}" stroke="#e5e7eb" stroke-width="1"/>`;
                     }).join('');
                     gridLines += `<line x1="${CX-RADIUS}" y1="${CY}" x2="${CX+RADIUS}" y2="${CY}" stroke="#d1d5db" stroke-width="1"/>`;
                } else {
                    levels.forEach(level => {
                        const r = RADIUS * level;
                        let points = [];
                        for(let i=0; i<count; i++) {
                            const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
                            points.push(`${CX + r * Math.cos(angle)},${CY + r * Math.sin(angle)}`);
                        }
                        gridLines += `<polygon points="${points.join(' ')}" fill="none" stroke="#e5e7eb" stroke-width="1"/>`;
                    });
                    for(let i=0; i<count; i++) {
                         const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
                         gridLines += `<line x1="${CX}" y1="${CY}" x2="${CX + RADIUS * Math.cos(angle)}" y2="${CY + RADIUS * Math.sin(angle)}" stroke="#d1d5db" stroke-width="1"/>`;
                    }
                }

                let initialPoints = [];
                for(let i=0; i<count; i++) initialPoints.push(`${CX},${CY}`);

                let markers = '';
                let labels = '';
                
                for(let i=0; i<count; i++) {
                    const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
                    const lx = CX + (RADIUS + 25) * Math.cos(angle);
                    const ly = CY + (RADIUS + 25) * Math.sin(angle);
                    
                    const displayVal = formatValue(vars[i].value, total);
                    const labelText = displayConfig.showLabels ? `${vars[i].name}\n${displayVal}` : vars[i].name;
                    
                    // Allow multiline text in SVG via tspans
                    const lines = labelText.split('\n');
                    const tspans = lines.map((line, idx) => `<tspan x="${lx}" dy="${idx === 0 ? 0 : '1.2em'}">${line}</tspan>`).join('');

                    labels += `<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" font-size="11" fill="#4b5563">${tspans}</text>`;
                    
                    markers += `<circle id="el-radar-pt-${i}" cx="${CX}" cy="${CY}" r="6" fill="${vars[i].color}" stroke="white" stroke-width="2" class="radar-point"/>`;
                }

                return `
                <div class="flex justify-center p-4">
                    <svg width="${SIZE}" height="${SIZE}" viewBox="0 0 ${SIZE} ${SIZE}" class="bg-white rounded-lg shadow-sm">
                        ${gridLines}
                        <polygon id="el-radar-poly" points="${initialPoints.join(' ')}" 
                                 fill="rgba(59, 130, 246, 0.2)" stroke="#3b82f6" stroke-width="2" class="radar-polygon"/>
                        ${markers}
                        ${labels}
                    </svg>
                </div>`;
            }

            return '';
        }

        function applyStyles(progress) {
            const total = variables.reduce((s, v) => s + (v.value>0?v.value:0), 0);
            const maxVal = Math.max(...variables.map(v => v.value>0?v.value:0));
            const maxSqrt = Math.sqrt(maxVal);
            
            const p = 1 - Math.pow(1 - progress, 3);

            // Generic elements loop
            variables.forEach((v, i) => {
                const el = document.getElementById(`el-${i}`);
                if (!el) return;

                if (chartStyle === CHART_STYLES.BARS) {
                    const targetPct = total > 0 ? (v.value / total) * 100 : 0;
                    el.style.width = `${targetPct * p}%`;
                }
                else if (chartStyle === CHART_STYLES.DONUT) {
                    const R = 100, C = 2 * Math.PI * R;
                    let prevPct = 0;
                    for(let j=0; j<i; j++) prevPct += (variables[j].value/total);
                    
                    const myPct = (v.value / total);
                    const targetDash = myPct * C;
                    const offset = C - (prevPct * C); 
                    
                    const currentDash = targetDash * p;
                    el.setAttribute('stroke-dasharray', `${currentDash} ${C - currentDash}`);
                    el.setAttribute('stroke-dashoffset', offset);
                }
                else if (chartStyle === CHART_STYLES.RECTANGLES) {
                    const MAX_H = 200;
                    const pct = total > 0 ? (v.value / total) * 100 : 0;
                    const targetH = (pct/100) * MAX_H;
                    el.style.height = `${targetH * p}px`;
                }
                else if (chartStyle === CHART_STYLES.CIRCLES || chartStyle === CHART_STYLES.PROP_SQUARES) {
                    const BASE = 120;
                    const val = v.value > 0 ? v.value : 0;
                    let targetScale = 0;
                    
                    if (chartStyle === CHART_STYLES.CIRCLES) {
                        targetScale = maxSqrt > 0 ? Math.sqrt(val) / maxSqrt : 0;
                    } else {
                        const BaseArea = BASE*BASE;
                        const propArea = maxVal > 0 ? (val/maxVal) * BaseArea : 0;
                        const side = Math.sqrt(propArea);
                        targetScale = maxVal > 0 ? side / BASE : 0;
                    }
                    el.style.transform = `scale(${targetScale * p})`;
                }
            });

            if (chartStyle === CHART_STYLES.PIE) {
                const SIZE = 200;
                let cumH = 0;
                for(let i=0; i<variables.length; i++) {
                    const el = document.getElementById(`el-${i}`);
                    if(!el) continue;
                    const v = variables[i];
                    const pct = total>0 ? (v.value/total) : 0;
                    const h = pct * SIZE;
                    el.style.bottom = `${cumH}px`;
                    el.style.height = `${h * p}px`; 
                    cumH += h;
                }
            }

            if (chartStyle === CHART_STYLES.LINE && variables.length >= 2) {
                const line = document.getElementById('el-line');
                if (line) {
                    const len = line.getTotalLength();
                    line.style.strokeDasharray = `${len} ${len}`;
                    line.style.strokeDashoffset = len * (1 - p);
                }
                variables.forEach((v, i) => {
                    const m = document.getElementById(`el-marker-${i}`);
                    if(m) m.style.transform = `scale(${1 * p})`;
                });
            }

            // Radar Chart Animation Logic
            if (chartStyle === CHART_STYLES.RADAR && variables.length >= 2) {
                const SIZE = 300;
                const CX = SIZE/2;
                const CY = SIZE/2;
                const RADIUS = 100;
                const count = variables.length;
                const effMax = maxVal > 0 ? maxVal : 1;

                let points = [];
                for(let i=0; i<count; i++) {
                    const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
                    const val = variables[i].value > 0 ? variables[i].value : 0;
                    // Current radius for animation
                    const r = RADIUS * (val / effMax) * p;
                    
                    const x = CX + r * Math.cos(angle);
                    const y = CY + r * Math.sin(angle);
                    points.push(`${x},${y}`);

                    // Move Markers
                    const marker = document.getElementById(`el-radar-pt-${i}`);
                    if(marker) {
                        marker.setAttribute('cx', x);
                        marker.setAttribute('cy', y);
                    }
                }
                
                // Update Polygon
                const poly = document.getElementById('el-radar-poly');
                if(poly) {
                    poly.setAttribute('points', points.join(' '));
                }
            }
        }

        function updatePreview() {
            const titleInput = document.getElementById('gifTitle');
            const previewTitle = document.getElementById('previewTitle');
            const chartContainer = document.getElementById('chartContainer');

            previewTitle.textContent = titleInput.value || "æ‚¨çš„æ•¸æ“šæ¯”è¼ƒ";

            const total = variables.reduce((s, v) => s + (v.value > 0 ? v.value : 0), 0);
            const maxVal = Math.max(...variables.map(v => v.value > 0 ? v.value : 0));

            if (total === 0 && maxVal === 0) {
                chartContainer.innerHTML = '<p class="text-center text-gray-500 p-10">è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸æ“šã€‚</p>';
                return;
            }

            chartContainer.innerHTML = getChartHTML(chartStyle, variables, total, maxVal);

            requestAnimationFrame(() => {
                applyStyles(1.0);
            });
        }

        // --- æ¨£å¼åˆ‡æ›è¼”åŠ©å‡½å¼ (ç”¨æ–¼æˆªåœ–æ™‚ç§»é™¤é‚Šæ¡†) ---
        function toggleCaptureStyles(enable) {
            const previewArea = document.getElementById('previewArea');
            const classesToRemove = ['shadow-lg', 'rounded-xl', 'border', 'border-gray-100'];
            
            if (enable) {
                // æº–å‚™æˆªåœ–ï¼šç§»é™¤è£é£¾
                previewArea.classList.remove(...classesToRemove);
            } else {
                // æˆªåœ–çµæŸï¼šæ¢å¾©è£é£¾
                previewArea.classList.add(...classesToRemove);
            }
        }

        // --- GIF ç”Ÿæˆé‚è¼¯ ---

        async function generateGIF() {
            const previewArea = document.getElementById('previewArea');
            const overlay = document.getElementById('loadingOverlay');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');

            let workerUrl = '';
            try {
                const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                if (!response.ok) throw new Error('Network response was not ok');
                const blob = await response.blob();
                workerUrl = URL.createObjectURL(blob);
            } catch (e) {
                alert('ç„¡æ³•åŠ è¼‰ GIF Worker å…ƒä»¶ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
                return;
            }

            // 1. æº–å‚™æˆªåœ–ç’°å¢ƒ
            toggleCaptureStyles(true); // ç§»é™¤é‚Šæ¡†
            
            // åˆå§‹åŒ– GIF - è¨­å®šç‚ºç™½è‰²èƒŒæ™¯ï¼Œé¿å…é€æ˜é›œé‚Š
            const gif = new GIF({
                workers: 2,
                quality: 10,
                workerScript: workerUrl,
                width: previewArea.offsetWidth,
                height: previewArea.offsetHeight,
                background: '#ffffff',
                transparent: null // ä¸ä½¿ç”¨é€æ˜ï¼Œå› ç‚º GIF é€æ˜åº¦æ”¯æ´æœ‰é™
            });

            overlay.classList.remove('hidden');
            loadingText.textContent = "æº–å‚™éŒ„è£½...";
            
            // é¸æ“‡æ‰€æœ‰å¯èƒ½çš„å‹•ç•«å…ƒç´ 
            const allAnimated = document.querySelectorAll('.bar-visual, .donut-segment, .chart-element-animate, .rectangle-bar, .circle-visual, .line-marker, #el-line, .radar-polygon, .radar-point');
            allAnimated.forEach(el => {
                el.style.transition = 'none'; 
            });

            const FRAMES = 20; 
            const DURATION = 1500; 
            const STAY_FRAMES = 10; 

            for (let i = 0; i <= FRAMES + STAY_FRAMES; i++) {
                let progress = i / FRAMES;
                if (i > FRAMES) progress = 1.0; 

                applyStyles(progress);

                const totalSteps = FRAMES + STAY_FRAMES;
                progressBar.style.width = `${(i / totalSteps) * 100}%`;
                loadingText.textContent = `éŒ„è£½ä¸­... ${Math.round((i / totalSteps) * 100)}%`;

                try {
                    const canvas = await html2canvas(previewArea, {
                        backgroundColor: '#ffffff', // å¼·åˆ¶ç™½åº•
                        scale: 1, 
                        logging: false
                    });
                    gif.addFrame(canvas, { delay: DURATION / FRAMES });
                } catch (err) {
                    console.error("Frame capture error:", err);
                }
                
                await new Promise(r => setTimeout(r, 10));
            }

            loadingText.textContent = "ç·¨ç¢¼ GIF ä¸­ (è«‹å‹¿é—œé–‰è¦–çª—)...";
            
            gif.on('finished', function(blob) {
                // æ¢å¾©ç’°å¢ƒ
                toggleCaptureStyles(false); // æ¢å¾©é‚Šæ¡†
                allAnimated.forEach(el => el.style.transition = '');
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${document.getElementById('gifTitle').value || 'chart'}.gif`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                overlay.classList.add('hidden');
                URL.revokeObjectURL(workerUrl);
            });

            gif.render();
        }

        // --- PNG ä¸‹è¼‰é‚è¼¯ ---
        function downloadPNG() {
            const previewArea = document.getElementById('previewArea');
            
            // 1. æº–å‚™æˆªåœ–ç’°å¢ƒ
            toggleCaptureStyles(true); // ç§»é™¤é‚Šæ¡†

            html2canvas(previewArea, { 
                backgroundColor: '#ffffff' // å¼·åˆ¶ç™½åº•ï¼Œè‹¥è¦é€æ˜å¯æ”¹ null
            }).then(canvas => {
                // 2. æ¢å¾©ç’°å¢ƒ
                toggleCaptureStyles(false); // æ¢å¾©é‚Šæ¡†

                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = `${document.getElementById('gifTitle').value || 'chart'}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }

        window.onload = () => {
            renderVariables();
            updatePreview();
        };
    </script>
</body>
</html>


